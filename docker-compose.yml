version: '3.8'

services:
   # IBeam - Client Portal Gateway (OAuth handles auth client-side)
   ibeam:
     image: voyz/ibeam:latest
     container_name: ibeam
     restart: unless-stopped
     volumes:
       - ibeam-data:/srv/ibeam
     environment:
       - IBEAM_START_ACTIVE=false  # Don't auto-login, OAuth handles auth
       - IBEAM_MAINTENANCE_INTERVAL=300  # Check every 5 minutes
     ports:
       - "5000:5000"  # Client Portal REST API
     healthcheck:
       test: ["CMD-SHELL", "curl -k -s https://localhost:5000/v1/api/tickle || exit 1"]
       interval: 30s
       timeout: 10s
       retries: 10
       start_period: 60s

  # Skim Trading Bot
   bot:
    build: .
    container_name: skim-bot
    restart: unless-stopped
    depends_on:
      - ibeam
    environment:
      - IB_HOST=${IB_HOST:-ibeam}
      - IB_PORT=${IB_PORT:-5000}
      - IB_CLIENT_ID=${IB_CLIENT_ID:-1}
      - PAPER_TRADING=${PAPER_TRADING:-true}
      - GAP_THRESHOLD=${GAP_THRESHOLD:-3.0}
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-1000}
      - MAX_POSITIONS=${MAX_POSITIONS:-5}
      - DB_PATH=${DB_PATH:-/app/data/skim.db}
      - IBIND_USE_OAUTH=True
      - IBIND_OAUTH1A_CONSUMER_KEY=${OAUTH_CONSUMER_KEY}
      - IBIND_OAUTH1A_ACCESS_TOKEN=${OAUTH_ACCESS_TOKEN}
      - IBIND_OAUTH1A_ACCESS_TOKEN_SECRET=${OAUTH_ACCESS_TOKEN_SECRET}
      - IBIND_OAUTH1A_SIGNATURE_KEY_FP=${OAUTH_SIGNATURE_PATH}
      - IBIND_OAUTH1A_ENCRYPTION_KEY_FP=${OAUTH_ENCRYPTION_PATH}
      - IBIND_OAUTH1A_DH_PRIME=${OAUTH_DH_PRIME}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./oauth_keys:/opt/skim/oauth_keys:ro
    networks:
      - skim-network

networks:
  skim-network:
    driver: bridge

volumes:
  ibeam-data: