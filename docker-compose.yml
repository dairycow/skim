version: '3.8'

services:
  # IBeam - Client Portal API Gateway with automated authentication
  ibeam:
    image: voyz/ibeam:latest
    container_name: ibeam
    restart: unless-stopped
    network_mode: bridge  # Required for Client Portal IP whitelist
    environment:
      - IBEAM_ACCOUNT=${IB_USERNAME}
      - IBEAM_PASSWORD=${IB_PASSWORD}
      - IBEAM_TWO_FA_HANDLER=EXTERNAL_REQUEST  # Manual phone approval
      - IBEAM_GATEWAY_BASE_URL=https://localhost:5000
      - IBEAM_PAGE_LOAD_TIMEOUT=180  # 3 minutes for 2FA approval
      - IBEAM_OAUTH_TIMEOUT=180  # 3 minutes for OAuth/2FA wait
      - IBEAM_REQUEST_RETRIES=1  # Reduce retry attempts
      - IBEAM_MAINTENANCE_INTERVAL=300  # Check every 5 min instead of default
    ports:
      - "5000:5000"  # Client Portal REST API
    volumes:
      - ibeam-data:/srv/ibeam
    healthcheck:
      test: ["CMD-SHELL", "curl -k -s https://localhost:5000/v1/api/tickle | grep -q authenticated || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s

  # Skim Trading Bot
  bot:
    build: .
    container_name: skim-bot
    restart: unless-stopped
    depends_on:
      - ibeam
    environment:
      - IB_HOST=${IB_HOST:-ibeam}
      - IB_PORT=${IB_PORT:-5000}
      - IB_CLIENT_ID=${IB_CLIENT_ID:-1}
      - PAPER_TRADING=${PAPER_TRADING:-true}
      - GAP_THRESHOLD=${GAP_THRESHOLD:-3.0}
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-1000}
      - MAX_POSITIONS=${MAX_POSITIONS:-5}
      - DB_PATH=${DB_PATH:-/app/data/skim.db}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - skim-network

networks:
  skim-network:
    driver: bridge

volumes:
  ibeam-data: